<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>טבלת פרסומים – חרמות</title>
  <style>
    body { font-family: 'Alef', Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    h2 { color: #1a3969; font-size: 2em; text-align: center; margin-bottom: 20px; }
    .filter-container { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; align-items: center; margin-bottom: 20px; }
    .filter-container label { display: flex; align-items: center; gap: 6px; font-weight: bold; color: #1a3969; }
    select { font-size: 1em; padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; }
    .add-button-container { text-align: left; margin-bottom: 10px; }
    .add-button-container a { background-color: #e0ecf8; color: #1a3969; padding: 6px 12px; font-size: 0.9em; border-radius: 6px; text-decoration: none; border: 1px solid #b6d0ea; }
    .add-button-container a:hover { background-color: #d2e4f5; }
    table { width: 100%; border-collapse: collapse; background: white; direction: rtl; border-radius: 6px; overflow: hidden; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #1a3969; color: white; }
    tr.impact-very-weak { background-color: #8B0000; color: white; }   /* מחלישה מאוד */
    tr.impact-weak { background-color: #FF9999; color: black; }       /* מחלישה קצת */
    tr.impact-strong { background-color: #99FF99; color: black; }     /* מחזקת קצת */
    tr.impact-very-strong { background-color: #006400; color: white; }/* מחזקת מאוד */
    a.date-link { color: #00b2e3; text-decoration: none; font-weight: bold; }
    a.date-link:hover { text-decoration: underline; }
    .error { color: #b00020; text-align: center; }
  </style>
</head>
<body>

<h2>טבלת פרסומים על חרמות נגד מדינת ישראל</h2>

<div class="filter-container">
  <label>סנן לפי נושא:
    <select id="topic-filter">
      <option value="all">הצג הכל</option>
    </select>
  </label>

  <label>סנן לפי השפעה:
    <select id="impact-filter">
      <option value="all">הצג הכל</option>
    </select>
  </label>

  <label>סנן לפי מקור:
    <select id="source-filter">
      <option value="all">הצג הכל</option>
    </select>
  </label>

  <label>סנן לפי תאריך:
    <select id="date-filter">
      <option value="all">כל התאריכים</option>
      <option value="7">7 ימים אחרונים</option>
      <option value="30">30 ימים אחרונים</option>
      <option value="90">90 ימים אחרונים</option>
    </select>
  </label>
</div>

<div class="add-button-container">
 <a href="https://www.hamatzav-hanatun.co.il/%D7%9E%D7%AA%D7%A2%D7%93%D7%99%D7%9D-%D7%99%D7%93%D7%99%D7%A2%D7%95%D7%AA-%D7%A2%D7%9C-%D7%97%D7%A8%D7%9E%D7%95%D7%AA" target="_blank" rel="noopener">➕ הוסף ידיעה</a>
</div>

<table id="data-table">
  <thead>
    <tr>
      <th>הנושא הרלוונטי</th>
      <th>השפעת הידיעה</th>
      <th>הערות</th>
      <th>מקור</th>
      <th>תאריך</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p id="load-error" class="error" style="display:none;"></p>

<script>
  // ===== CONFIG =====
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz71CXSrcIO_i_aoFK1pjj0ef5_evp9Zcl0pxbpRH3X3-u558kVT_nq7u0F94Yxfgrf/exec';

  let allData = [];

  const topicFilter = document.getElementById("topic-filter");
  const impactFilter = document.getElementById("impact-filter");
  const sourceFilter = document.getElementById("source-filter");
  const dateFilter = document.getElementById("date-filter");
  const loadError = document.getElementById("load-error");

  function extractDomain(url) {
    try { return new URL(url).hostname.replace(/^www\./, ''); }
    catch { return 'לא ידוע'; }
  }

  // ✅ פרסור עמיד וגמיש עבור InfoDate ו־Timestamp
  function parseKnownDate(infoDateStr, timestampStr) {
    const clean = s => (typeof s === 'string' ? s.trim() : '');

    // עזר: יוצר תאריך בטוח מ־YYYY-MM-DD (כשדה תאריך בלבד, מקומי, בלי הזחות UTC)
    const fromYMD = (y, m, d) => {
      const year = Number(y), month = Number(m), day = Number(d);
      const dt = new Date(year, month - 1, day, 0, 0, 0, 0);
      return isNaN(dt) ? null : dt;
    };

    // 1) קודם InfoDate
    let s = clean(infoDateStr);
    if (s) {
      // DD/MM/YYYY או DD-MM-YYYY או DD.MM.YYYY
      let m = s.match(/^(\d{2})[\/.-](\d{2})[\/.-](\d{4})$/);
      if (m) {
        const dt = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        if (!isNaN(dt)) return dt;
      }
      // YYYY-MM-DD או YYYY/MM/DD או YYYY.MM.DD
      m = s.match(/^(\d{4})[\/.-](\d{2})[\/.-](\d{2})$/);
      if (m) {
        const dt = fromYMD(m[1], m[2], m[3]);
        if (dt) return dt;
      }
      // ISO מלא או כמעט מלא (ננסה ישירות)
      const tryISO = new Date(s);
      if (!isNaN(tryISO)) return tryISO;
    }

    // 2) אם אין InfoDate תקין ‐ ננסה Timestamp
    s = clean(timestampStr);
    if (s) {
      // אם יש רווח בין תאריך לשעה, נהפוך ל־T (לא נוסיף Z!)
      const normalized = s.includes('T') ? s : s.replace(' ', 'T');

      // נסיון ראשון: לתת ל־Date לפרסר לבד (כולל אזורי זמן אם קיימים, כולל ISO)
      let dt = new Date(normalized);
      if (!isNaN(dt)) return dt;

      // DD/MM/YYYY HH:MM[:SS]
      let m = s.match(/^(\d{2})[\/.-](\d{2})[\/.-](\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (m) {
        dt = new Date(
          Number(m[3]),
          Number(m[2]) - 1,
          Number(m[1]),
          Number(m[4]),
          Number(m[5]),
          Number(m[6] || 0)
        );
        if (!isNaN(dt)) return dt;
      }

      // YYYY-MM-DD HH:MM[:SS] (ללא אזור זמן) ‐ נתייחס כזמן מקומי
      m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (m) {
        dt = new Date(
          Number(m[1]),
          Number(m[2]) - 1,
          Number(m[3]),
          Number(m[4]),
          Number(m[5]),
          Number(m[6] || 0)
        );
        if (!isNaN(dt)) return dt;
      }
    }

    return null;
  }

  function formatDate(dateObj) {
    if (!(dateObj instanceof Date) || isNaN(dateObj)) return "אין תאריך";
    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const year = dateObj.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function classByImpact(impact) {
    switch ((impact || '').trim()) {
      case 'מחלישה מאוד': return 'impact-very-weak';
      case 'מחלישה קצת': return 'impact-weak';
      case 'מחזקת קצת': return 'impact-strong';
      case 'מחזקת מאוד': return 'impact-very-strong';
      default: return '';
    }
  }

  function renderTable(data) {
    const tbody = document.querySelector("#data-table tbody");
    tbody.innerHTML = "";
    data
      .slice()
      .sort((a, b) => (b.dateObj?.getTime() || 0) - (a.dateObj?.getTime() || 0))
      .forEach(row => {
        const tr = document.createElement("tr");
        const cls = classByImpact(row.impact);
        if (cls) tr.classList.add(cls);

        const dateLabel = formatDate(row.dateObj);
        const dateCell = row.link
          ? `<a href="${row.link}" target="_blank" class="date-link">${dateLabel}</a>`
          : dateLabel;

        tr.innerHTML = `
          <td>${row.topic || ''}</td>
          <td>${row.impact || ''}</td>
          <td>${row.comments || ''}</td>
          <td>${row.sourceDomain || 'לא ידוע'}</td>
          <td>${dateCell}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  function updateFilterCounts(filteredData) {
    const countBy = field => filteredData.reduce((acc, r) => ((acc[r[field]] = (acc[r[field]] || 0) + 1), acc), {});
    const updateOptions = (selectEl, counts, allLabel) => {
      Array.from(selectEl.options).forEach(opt => {
        if (opt.value === "all") opt.textContent = allLabel;
        else opt.textContent = `${opt.value} (${counts[opt.value] || 0})`;
      });
    };
    updateOptions(topicFilter, countBy('topic'), "הצג הכל");
    updateOptions(impactFilter, countBy('impact'), "הצג הכל");
    updateOptions(sourceFilter, countBy('sourceDomain'), "הצג הכל");
  }

  function applyFilters() {
    const t = topicFilter.value;
    const i = impactFilter.value;
    const s = sourceFilter.value;
    const d = dateFilter.value;
    const now = new Date();
    const msDay = 86400000;

    const filtered = allData.filter(r => {
      const matchT = (t === 'all' || r.topic === t);
      const matchI = (i === 'all' || r.impact === i);
      const matchS = (s === 'all' || r.sourceDomain === s);
      const matchD = (d === 'all') || (r.dateObj && (now - r.dateObj <= parseInt(d, 10) * msDay));
      return matchT && matchI && matchS && matchD;
    });

    renderTable(filtered);
    updateFilterCounts(filtered);
  }

  function populateFiltersFromData(data) {
    const topics = new Set(), impacts = new Set(), sources = new Set();
    data.forEach(r => { if (r.topic) topics.add(r.topic); if (r.impact) impacts.add(r.impact); if (r.sourceDomain) sources.add(r.sourceDomain); });

    const addOpts = (selectEl, items) => {
      selectEl.length = 1;
      [...items].sort().forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        selectEl.appendChild(o);
      });
    };

    addOpts(topicFilter, topics);
    addOpts(impactFilter, impacts);
    addOpts(sourceFilter, sources);
  }

  function loadData() {
    fetch(`${SCRIPT_URL}?mode=submissions`)
      .then(r => {
        if (!r.ok) throw new Error('סטטוס רשת ' + r.status);
        return r.json();
      })
      .then(rows => {
        allData = rows
          .filter(row => row.link && String(row.link).trim() !== '')
          .map(row => {
            const link = String(row.link).trim();
            return {
              link,
              topic: (row.topic || '').trim(),
              impact: (row.impact || '').trim(),
              comments: (row.comments || '').trim(),
              sourceDomain: extractDomain(link),
              dateObj: parseKnownDate(row.infoDate, row.timestamp)
            };
          });

        if (!allData.length) throw new Error('לא נמצאו נתונים להצגה');

        populateFiltersFromData(allData);
        renderTable(allData);
        updateFilterCounts(allData);

        topicFilter.addEventListener("change", applyFilters);
        impactFilter.addEventListener("change", applyFilters);
        sourceFilter.addEventListener("change", applyFilters);
        dateFilter.addEventListener("change", applyFilters);
      })
      .catch(err => {
        loadError.style.display = 'block';
        loadError.textContent = '⚠️ שגיאה בטעינת הנתונים: ' + err.message;
        console.error(err);
      });
  }

  loadData();
</script>

</body>
</html>
